import requests
import re
from geopy.geocoders import Nominatim
from geopy.exc import GeocoderTimedOut
import time
# https://www.blackbox.ai/
import random
geolocator = Nominatim(user_agent="MyGeoBot/1.0")
def get_chatbot_response(user_text: str):
    # Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ API
    url = f"http://api.api-code.ir/api/ai-chatbot/?text={user_text}"
    response = requests.get(url)
    
    # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù¾Ø§Ø³Ø® API
    if response.status_code == 200:
        data = response.json()
        if "Result" in data:
            # Ø­Ø°Ù Ù‚Ø³Ù…Øª Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ùˆ Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø´ØªÙ† ÙÙ‚Ø· Ù¾Ø§Ø³Ø®
            result_text = data["Result"]
            cleaned_text = re.sub(r"Generated by BLACKBOXAI.*?try unlimited chat.*\n\n", "", result_text, flags=re.DOTALL)
            return cleaned_text.strip()
        else:
            return "Ù¾Ø§Ø³Ø®ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯."
    else:
        return f"Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ APIØŒ Ú©Ø¯ ÙˆØ¶Ø¹ÛŒØª: {response.status_code}"

def get_random_music_link():
    api_url = "https://api-free.ir/api/music/"
    response = requests.get(api_url)
    if response.status_code == 200:
        data = response.json()
        if data.get("ok") and data.get("result") and data["result"].get("song"):
            return data["result"]["song"]
    return None
def get_song(search_text: str):
    try:
        # Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ API Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¢Ù‡Ù†Ú¯
        url = f"https://api-free.ir/api/sr-music/?text={search_text}"
        response = requests.get(url)
        
        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù¾Ø§Ø³Ø® API
        if response.status_code == 200:
            data = response.json()
            if data.get("ok") and "result" in data:
                return data["result"]  # Ø¹Ù†ÙˆØ§Ù† Ùˆ Ù„ÛŒÙ†Ú© Ø¢Ù‡Ù†Ú¯
            else:
                return {"error": "Ø¢Ù‡Ù†Ú¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯ ÛŒØ§ Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ù¾Ø§Ø³Ø® API ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯."}
        else:
            return {"error": f"Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ APIØŒ Ú©Ø¯ ÙˆØ¶Ø¹ÛŒØª: {response.status_code}"}
            
    except Exception as e:
        return {"error": f"ÛŒÚ© Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø±Ø® Ø¯Ø§Ø¯: {e}"}
    


def fetch_estekhare():
    url = "http://api-free.ir/api/es.php"
    response = requests.get(url)
    data = response.json()
    return data




# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª ÙˆÛŒØ¯ÛŒÙˆ Ø§Ø² API
def fetch_video():
    try:
        response = requests.get("https://api-free.ir/api/video/")
        if response.status_code == 200 and response.json().get("ok"):
            video_url = response.json()["result"]["url"]
            caption = response.json()["result"]["caption"]
            return video_url, caption
    except Exception as e:
        print("Error fetching video:", e)
    return None, None

def fetch_prof():
    try:
        response = requests.get("https://api-free.ir/api/prof.php")
        if response.status_code == 200 and response.json().get("ok"):
            texts = response.json()['result']
            return random.choice(texts)
        else:
            print("API Error: Ø¯Ø±ÛŒØ§ÙØª Ù…ØªÙ† Ù…Ù…Ú©Ù† Ù†ÛŒØ³Øª.")
            return None
    except Exception as e:
        print("Error:", e)
        return None

def fetch_audio(text, voice_type):
    # Ø¢Ø¯Ø±Ø³ ÙˆØ¨â€ŒØ³Ø±ÙˆÛŒØ³ Ø¨Ù‡ Ù‡Ù…Ø±Ø§Ù‡ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§
    url = f"https://api.api-code.ir/text-to-voice/?text={text}&type={voice_type}"
    
    # Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ ÙˆØ¨â€ŒØ³Ø±ÙˆÛŒØ³
    response = requests.get(url)
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø±Ø®ÙˆØ§Ø³Øª
    if response.status_code == 200:
        data = response.json()
        if data["status"] == "success":
            # Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ
            audio_url = data["audio"]
            audio_response = requests.get(audio_url)
            if audio_response.status_code == 200:
                audio_path = f"{voice_type}_{text}.ogg"
                with open(audio_path, "wb") as audio_file:
                    audio_file.write(audio_response.content)
                return audio_path
    return None



# Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ù‚ÛŒÙ‚ BMI
def calculate_bmi(weight, height):
    try:
        bmi = weight / (height ** 2)  # BMI = ÙˆØ²Ù† (Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…) / (Ù‚Ø¯ (Ù…ØªØ±) ^ 2)
        return round(bmi, 2)
    except ZeroDivisionError:
        return None

# ØªÙˆØµÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø²Ø´Ú©ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø±Ø§Ø³Ø§Ø³ BMI
def get_bmi_advice(bmi):
    if bmi < 18.5:
        return ("Ø´Ù…Ø§ Ø¯Ú†Ø§Ø± **Ú©Ù…Ø¨ÙˆØ¯ ÙˆØ²Ù†** Ù‡Ø³ØªÛŒØ¯. Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø¨Ø§ Ù¾Ø²Ø´Ú© ÛŒØ§ Ù…ØªØ®ØµØµ ØªØºØ°ÛŒÙ‡ Ù…Ø´ÙˆØ±Øª Ú©Ù†ÛŒØ¯. "
                "Ø¨Ø§ ØªØºØ°ÛŒÙ‡ Ù…ØªØ¹Ø§Ø¯Ù„ Ùˆ Ù…ØµØ±Ù ØºØ°Ø§Ù‡Ø§ÛŒ Ù…ØºØ°ÛŒØŒ Ù…ÛŒØ²Ø§Ù† Ú©Ø§Ù„Ø±ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÙØ²Ø§ÛŒØ´ Ø¯Ù‡ÛŒØ¯. "
                "ÙˆØ±Ø²Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ù‚Ø§ÙˆÙ…ØªÛŒ Ùˆ ØªÙ‚ÙˆÛŒØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø¹Ø¶Ù„Ø§Øª Ù†ÛŒØ² Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ù…ÙÛŒØ¯ Ø§Ø³Øª.")
    elif 18.5 <= bmi < 24.9:
        return ("ÙˆØ²Ù† Ø´Ù…Ø§ Ø¯Ø± Ù…Ø­Ø¯ÙˆØ¯Ù‡ **Ù†Ø±Ù…Ø§Ù„** Ø§Ø³Øª. Ø¨Ù‡â€ŒØ·ÙˆØ± Ù…Ø±ØªØ¨ Ø±Ú˜ÛŒÙ… ØºØ°Ø§ÛŒÛŒ Ø³Ø§Ù„Ù… Ùˆ ÙØ¹Ø§Ù„ÛŒØª Ø¨Ø¯Ù†ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ù‡ÛŒØ¯. "
                "Ø³Ø¨Ú© Ø²Ù†Ø¯Ú¯ÛŒ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ Ø­ÙØ¸ Ø³Ù„Ø§Ù…ØªÛŒ Ø´Ù…Ø§ Ú©Ù…Ú© Ú©Ù†Ø¯.")
    elif 25 <= bmi < 29.9:
        return ("Ø´Ù…Ø§ Ø¯Ø§Ø±Ø§ÛŒ **Ø§Ø¶Ø§ÙÙ‡ ÙˆØ²Ù†** Ù‡Ø³ØªÛŒØ¯. Ø¨Ø±Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ ÙˆØ¶Ø¹ÛŒØªØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø±Ú˜ÛŒÙ… ØºØ°Ø§ÛŒÛŒ Ù…ØªØ¹Ø§Ø¯Ù„â€ŒØªØ± Ùˆ ÙˆØ±Ø²Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ø§Ø³Ø¨ "
                "Ù…Ø§Ù†Ù†Ø¯ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ±ÙˆÛŒ ÛŒØ§ Ø¯ÙˆÛŒØ¯Ù† Ø±Ø§ Ø¯Ø± Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø®ÙˆØ¯ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.")
    elif 30 <= bmi < 34.9:
        return ("Ø´Ù…Ø§ Ø¯Ú†Ø§Ø± **Ú†Ø§Ù‚ÛŒ** Ù‡Ø³ØªÛŒØ¯. Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø¨Ø§ ÛŒÚ© Ù…ØªØ®ØµØµ ØªØºØ°ÛŒÙ‡ Ù…Ø´ÙˆØ±Øª Ú©Ù†ÛŒØ¯. "
                "Ú©Ø§Ù‡Ø´ ÙˆØ²Ù† Ø¨Ù‡â€ŒÙˆØ³ÛŒÙ„Ù‡ Ø±Ú˜ÛŒÙ… ØºØ°Ø§ÛŒÛŒ Ú©Ù…â€ŒÚ©Ø§Ù„Ø±ÛŒ Ùˆ ÙØ¹Ø§Ù„ÛŒØª Ø¨Ø¯Ù†ÛŒ Ù…Ù†Ø¸Ù… Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ Ø´Ù…Ø§ Ú©Ù…Ú© Ú©Ù†Ø¯.")
    elif 35 <= bmi < 39.9:
        return ("Ø´Ù…Ø§ Ø¯Ú†Ø§Ø± **Ú†Ø§Ù‚ÛŒ Ø´Ø¯ÛŒØ¯** Ù‡Ø³ØªÛŒØ¯. Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù‡Ø´ ÙˆØ²Ù†ØŒ Ù…Ø´Ø§ÙˆØ±Ù‡ Ù¾Ø²Ø´Ú©ÛŒ Ùˆ Ú©Ù…Ú© Ø§Ø² Ù…ØªØ®ØµØµ ØªØºØ°ÛŒÙ‡ Ø¶Ø±ÙˆØ±ÛŒ Ø§Ø³Øª. "
                "ÙØ¹Ø§Ù„ÛŒØª Ø¨Ø¯Ù†ÛŒ Ù…Ù†Ø¸Ù… Ùˆ Ø±Ú˜ÛŒÙ… ØºØ°Ø§ÛŒÛŒ Ù…Ù†Ø§Ø³Ø¨ Ø¨Ù‡ Ø´Ù…Ø§ Ú©Ù…Ú© Ø®ÙˆØ§Ù‡Ø¯ Ú©Ø±Ø¯.")
    else:
        return ("Ø´Ù…Ø§ Ø¯Ú†Ø§Ø± **Ú†Ø§Ù‚ÛŒ Ù…ÙØ±Ø·** Ù‡Ø³ØªÛŒØ¯. Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ØŒ Ù…Ø´ÙˆØ±Øª ÙÙˆØ±ÛŒ Ø¨Ø§ Ù¾Ø²Ø´Ú© Ùˆ Ù…ØªØ®ØµØµ ØªØºØ°ÛŒÙ‡ Ø¨Ø³ÛŒØ§Ø± Ø¶Ø±ÙˆØ±ÛŒ Ø§Ø³Øª. "
                "Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù‡Ø´ ÙˆØ²Ù† ØªØ­Øª Ù†Ø¸Ø± Ù…ØªØ®ØµØµÛŒÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ Ø´Ù…Ø§ Ú©Ù…Ú© Ú©Ù†Ø¯.")

# Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
def validate_input(message_text):
    if message_text.startswith("bmi:"):
        try:
            params = message_text[4:].split(',')
            weight = float(params[0].split('=')[1].strip())  # ÙˆØ²Ù†
            height = float(params[1].split('=')[1].strip())  # Ù‚Ø¯
            if weight <= 0 or height <= 0:
                return None, "ğŸš« ÙˆØ²Ù† ÛŒØ§ Ù‚Ø¯ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù…Ø«Ø¨Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯."
            return weight, height, None
        except (ValueError, IndexError):
            return None, None, "ğŸš« ÙØ±Ù…Øª ÙˆØ±ÙˆØ¯ÛŒ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø§Ø² ÙØ±Ù…Øª `bmi:w=ÙˆØ²Ù†,h=Ù‚Ø¯` Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯."
    return None, None, "ğŸš« Ù„Ø·ÙØ§Ù‹ ÙØ±Ù…Øª ØµØ­ÛŒØ­ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯. Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ BMI Ø§Ø² ÙØ±Ù…Øª `bmi:w=ÙˆØ²Ù†,h=Ù‚Ø¯` Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯."

# ØªØ§Ø¨Ø¹ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù…Ú©Ø§Ù† Ø§Ø² geolocator Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª Ù„ÛŒÙ†Ú© Ú¯ÙˆÚ¯Ù„ Ù…Ù¾Ø³
def get_location_map(location_name):
    try:
        # ØªØ¨Ø¯ÛŒÙ„ Ù…Ú©Ø§Ù† Ø¨Ù‡ Ù…Ø®ØªØµØ§Øª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ
        location = geolocator.geocode(location_name)
        if location:
            latitude = location.latitude
            longitude = location.longitude
            # Ø³Ø§Ø®Øª Ù„ÛŒÙ†Ú© Ú¯ÙˆÚ¯Ù„ Ù…Ù¾Ø³
            google_maps_url = f"https://www.google.com/maps?q={latitude},{longitude}"
            return google_maps_url
        else:
            return "Ù…Ú©Ø§Ù† Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯."
    except GeocoderTimedOut:
        # Ø¯Ø± ØµÙˆØ±Øª Ø¨Ø±ÙˆØ² Ø®Ø·Ø§ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø²Ù…Ø§Ù†â€ŒØ¨Ø± Ø¨ÙˆØ¯Ù† Ù¾Ø§Ø³Ø®
        time.sleep(5)
        return get_location_map(location_name)  # ØªÙ„Ø§Ø´ Ø¯ÙˆØ¨Ø§Ø±Ù‡
    except Exception as e:
        return f"Ø®Ø·Ø§: {str(e)}"
    
    
async def search_myket(query: str):
    url = "https://pybot.info/api/myket.php"
    params = {
        "text": query,  # Ù…ØªÙ† Ø¬Ø³ØªØ¬Ùˆ
        "lang": "fa",    # Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ
        "count": 1       # ÙÙ‚Ø· ÛŒÚ© Ù†ØªÛŒØ¬Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    }
    
    # Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ API Ù…Ø§ÛŒÚ©Øª
    response = requests.get(url, params=params)
    data = response.json()
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù‡Ø³ØªÙ†Ø¯
    if data.get('ok'):
        results = data.get('data', [])
        return results[0] if results else None  # ÙÙ‚Ø· Ø§ÙˆÙ„ÛŒÙ† Ù†ØªÛŒØ¬Ù‡ Ø±Ø§ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯
    else:
        return None
    

